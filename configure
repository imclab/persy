#!/bin/sh

if [ -e Makefile ]; then
	rm Makefile;
fi

#build default
build="genversion"

#docs
docs="man html latex"

#python modules
pymods="gettext getpass platform paramiko subprocess pynotify pyinotify gtk gtk.glade pygtk"

for pymod in $pymods; do
    echo -n "Testing python module $pymod: "
    python -c "import $pymod" 2> /dev/null
    retval=$?
    if [ "$retval" -eq "0" ]; then
        echo "ok."
    else
        echo "fail."
        exit 1
    fi
done

#translations
mos=""
langs=""
echo -n "Translations........: "
for langdir in `ls -d usr/lib/persy/locale/*/`; do
    lang=`echo $langdir | cut -d/ -f5`
    langs="$lang $langs"
    echo -n "$lang"
done
echo -e ""

#Start Makefile
echo -e "LANGS=$langs" >> Makefile
echo -e "SHELL=`which sh`" >> Makefile
echo -e "" >> Makefile

#add template
cat Makefile.template >> Makefile

#add translation install
echo -e "install_translations:" >> Makefile
for lang in $langs; do
    echo -e "\tinstall -d \$(DEST)/lib/persy/locale/$lang/LC_MESSAGES" >> Makefile
    echo -e "\tinstall --mode=644 usr/lib/persy/locale/$lang/LC_MESSAGES/messages.mo \$(DEST)/lib/persy/locale/$lang/LC_MESSAGES/messages.mo" >> Makefile
done
echo -e "" >> Makefile

#test build and install docs
echo -e "install_docs:" >> Makefile
for doc in $docs; do
    rmdocs=""
    case $doc in
        "man")
            echo -n "Make man file.......: "
            if [ -z `which pandoc 2> /dev/null` ]; then
                echo -e "No. (pandoc not installed)"
            else
                echo -e "\tinstall --mode=644 usr/share/man/man1/persy.1.gz \$(DEST)/share/man/man1/persy.1.gz" >> Makefile
                echo "Yes."
                build="$build doc-$doc"  
                rmdocs="$rmdocs $doc"          
            fi
            ;;
        "html")
            echo -n "Make doc html.......: "
            if [ -z `which sphinx-build 2> /dev/null` ]; then
                echo -e "No. (python-sphinx not installed)"
            else
                #TODO: install
                echo "Yes."
                build="$build doc-$doc"
                rmdocs="$rmdocs $doc"
            fi
            ;;
        "latex")
            echo -n "Make doc latex......: "
            if [ -z `which sphinx-build 2> /dev/null` ]; then
                echo -e "No. (python-sphinx not installed)"
            else
                #TODO: install
                echo "Yes."
                build="$build doc-$doc"
                rmdocs="$rmdocs $doc"
            fi
            ;;        
        *)
            echo -e "Found no build and installation instructions for doc-$doc. skip."
            ;;
    esac
done
echo -e "\t" >> Makefile

#add doc remove
echo -e "remove_docs:" >> Makefile
for doc in $rmdocs; do
    case $doc in
        "man") echo -e "\trm \$(DEST)/share/man/man1/persy.1.gz";;
        #TODO: html, latex
    esac
done
echo -e "" >> Makefile

#rebuild languagefile
echo -n "Rebuild languagefile: "
if [ -z `which xgettext 2> /dev/null` ]; then
    echo -e "No. (xgettext not installed)" 
else
    echo -e "languagefile:" >> Makefile
	echo -e "\txgettext usr/lib/persy/*.py -o usr/lib/persy/locale/messages.pot" >> Makefile
	echo -e "" >> Makefile
	echo -e "Yes."
	build="$build languagefile"    
fi

# add clean
echo -e "clean:" >> Makefile
echo -e "\trm usr/lib/persy/VERSION" >> Makefile
echo -e "\trm -rf usr/share/man/man1" >> Makefile
case $doc in
    "man") rm usr/share/man/man1/persy.1.gz;;
esac

#add build
echo -e "build: $build" >> Makefile

echo -e "" >> Makefile
echo "All OK. Now run:"
echo "    make"
echo "    sudo make install"
